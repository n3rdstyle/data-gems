<!DOCTYPE html>
<html>
<head>
    <title>üß™ Subprofile ID Matching Test</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .test-step { 
            margin: 25px 0; 
            padding: 20px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            background: #fafafa;
        }
        .test-step.active { 
            border-color: #3b82f6; 
            background: #eff6ff; 
        }
        .test-step.success { 
            border-color: #10b981; 
            background: #f0fdf4; 
        }
        .test-step.error { 
            border-color: #ef4444; 
            background: #fef2f2; 
        }
        .test-step h3 { 
            margin-top: 0; 
            color: #1f2937; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        code { 
            background: #f3f4f6; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .highlight { 
            background: #fef3c7; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: 600;
        }
        .debug-output { 
            background: #111827; 
            color: #f9fafb; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px; 
            white-space: pre-wrap; 
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            margin-right: 10px;
        }
        .status-pending { background: #6b7280; }
        .status-active { background: #3b82f6; animation: pulse 2s infinite; }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        .button:hover { background: #2563eb; }
        .button:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .data-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .data-column {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .data-column h4 { margin-top: 0; color: #475569; }
        .id-list { 
            font-family: monospace; 
            font-size: 12px; 
            color: #1e293b;
            line-height: 1.4;
        }
        
        .critical-issue {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .critical-issue h4 {
            color: #dc2626;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Data Gems Subprofile ID Matching Test</h1>
        <p>This test will verify that data items are correctly associated with subprofiles through ID tagging.</p>
        
        <div class="test-step" id="step1">
            <h3>
                <span class="status-indicator status-pending" id="status1"></span>
                Step 1: Load Extension Data
            </h3>
            <p>First, we need to load the current contextItems and subprofiles from Chrome storage.</p>
            <button class="button" onclick="loadExtensionData()" id="loadBtn">Load Data</button>
            <div class="debug-output" id="loadOutput" style="display: none;"></div>
        </div>

        <div class="test-step" id="step2">
            <h3>
                <span class="status-indicator status-pending" id="status2"></span>
                Step 2: Analyze Current Data Structure
            </h3>
            <p>Examine the structure of contextItems and any existing subprofiles.</p>
            <div class="data-comparison" id="dataComparison" style="display: none;">
                <div class="data-column">
                    <h4>üìã Context Items</h4>
                    <div id="contextItemsDisplay" class="id-list">Loading...</div>
                </div>
                <div class="data-column">
                    <h4>üè∑Ô∏è Subprofiles</h4>
                    <div id="subprofilesDisplay" class="id-list">Loading...</div>
                </div>
            </div>
        </div>

        <div class="test-step" id="step3">
            <h3>
                <span class="status-indicator status-pending" id="status3"></span>
                Step 3: Test ID Matching Logic
            </h3>
            <p>Simulate the filtering process that happens when a subprofile is selected.</p>
            <button class="button" onclick="testFiltering()" id="filterBtn" disabled>Test Filtering</button>
            <div class="debug-output" id="filterOutput" style="display: none;"></div>
        </div>

        <div class="test-step" id="step4">
            <h3>
                <span class="status-indicator status-pending" id="status4"></span>
                Step 4: Verify Active Subprofile
            </h3>
            <p>Check if there's an active subprofile and test its filtering behavior.</p>
            <div id="activeSubprofileTest" style="display: none;"></div>
        </div>

        <div class="test-step" id="step5">
            <h3>
                <span class="status-indicator status-pending" id="status5"></span>
                Step 5: Create Test Subprofile
            </h3>
            <p>Create a test subprofile with specific item IDs to verify the tagging system works.</p>
            <button class="button" onclick="createTestSubprofile()" id="createBtn" disabled>Create Test Subprofile</button>
            <div class="debug-output" id="createOutput" style="display: none;"></div>
        </div>

        <div id="criticalIssues" style="display: none;">
            <div class="critical-issue">
                <h4>üö® Critical Issues Found</h4>
                <div id="issuesList"></div>
            </div>
        </div>

        <div id="testResults" style="display: none;">
            <h2>üìä Test Results Summary</h2>
            <div id="resultsSummary"></div>
        </div>
    </div>

    <script>
        let contextItems = [];
        let subprofiles = [];
        let activeSubprofileId = null;
        let testResults = {
            dataLoaded: false,
            idsConsistent: false,
            filteringWorks: false,
            issues: []
        };

        function setStepStatus(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            const statusIndicator = document.getElementById(`status${stepNum}`);
            
            step.className = `test-step ${status}`;
            statusIndicator.className = `status-indicator status-${status}`;
        }

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            if (isError) {
                element.style.color = '#ef4444';
            }
            element.textContent += message + '\n';
        }

        async function loadExtensionData() {
            setStepStatus(1, 'active');
            const loadBtn = document.getElementById('loadBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            
            try {
                // Simulate chrome.storage.local.get calls
                log('loadOutput', 'üîç Attempting to load extension data...');
                log('loadOutput', 'üìã Loading contextItems from chrome.storage.local...');
                log('loadOutput', 'üè∑Ô∏è Loading subprofiles from chrome.storage.local...');
                log('loadOutput', 'üéØ Loading active subprofile ID...');
                
                // Since we can't actually access chrome.storage from a web page,
                // we'll provide instructions for manual testing
                log('loadOutput', '');
                log('loadOutput', '‚ö†Ô∏è  MANUAL STEP REQUIRED:');
                log('loadOutput', '1. Open Chrome DevTools (F12)');
                log('loadOutput', '2. Go to Application tab > Storage > Local Storage');
                log('loadOutput', '3. Find the Data Gems extension entry');
                log('loadOutput', '4. Copy the values and paste them below:');
                log('loadOutput', '');
                log('loadOutput', 'üîß Alternative: Open extension popup and check console logs');
                
                setStepStatus(1, 'success');
                setStepStatus(2, 'active');
                showDataAnalysis();
                
            } catch (error) {
                log('loadOutput', `‚ùå Error: ${error.message}`, true);
                setStepStatus(1, 'error');
                testResults.issues.push('Failed to load extension data: ' + error.message);
            }
        }

        function showDataAnalysis() {
            document.getElementById('dataComparison').style.display = 'grid';
            
            const contextDisplay = document.getElementById('contextItemsDisplay');
            const subprofilesDisplay = document.getElementById('subprofilesDisplay');
            
            contextDisplay.innerHTML = `
                <strong>Expected Structure:</strong><br>
                [<br>
                &nbsp;&nbsp;{<br>
                &nbsp;&nbsp;&nbsp;&nbsp;id: "uuid-or-timestamp",<br>
                &nbsp;&nbsp;&nbsp;&nbsp;category: "Category Name",<br>
                &nbsp;&nbsp;&nbsp;&nbsp;question: "Question text",<br>
                &nbsp;&nbsp;&nbsp;&nbsp;answer: "Answer text",<br>
                &nbsp;&nbsp;&nbsp;&nbsp;createdAt: Date,<br>
                &nbsp;&nbsp;&nbsp;&nbsp;updatedAt: Date<br>
                &nbsp;&nbsp;}<br>
                ]<br><br>
                <span style="color: #dc2626;">‚ö†Ô∏è Check console for actual data</span>
            `;
            
            subprofilesDisplay.innerHTML = `
                <strong>Expected Structure:</strong><br>
                [<br>
                &nbsp;&nbsp;{<br>
                &nbsp;&nbsp;&nbsp;&nbsp;id: "subprofile-uuid",<br>
                &nbsp;&nbsp;&nbsp;&nbsp;name: "Profile Name",<br>
                &nbsp;&nbsp;&nbsp;&nbsp;includedFields: {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextItems: ["item-id-1", "item-id-2"]<br>
                &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                &nbsp;&nbsp;}<br>
                ]<br><br>
                <span style="color: #dc2626;">‚ö†Ô∏è Check console for actual data</span>
            `;
            
            document.getElementById('filterBtn').disabled = false;
            setStepStatus(2, 'success');
        }

        function testFiltering() {
            setStepStatus(3, 'active');
            const filterBtn = document.getElementById('filterBtn');
            filterBtn.disabled = true;
            filterBtn.textContent = 'Testing...';
            
            log('filterOutput', 'üß™ Testing ID Matching Logic');
            log('filterOutput', '');
            log('filterOutput', 'üìã Simulating filterItems() function behavior:');
            log('filterOutput', '');
            
            // Simulate the actual filtering logic from popup.js
            log('filterOutput', 'function filterItems() {');
            log('filterOutput', '  let itemsToFilter = contextItems;');
            log('filterOutput', '  ');
            log('filterOutput', '  if (activeSubprofileId) {');
            log('filterOutput', '    const activeSubprofile = subprofiles.find(s => s.id === activeSubprofileId);');
            log('filterOutput', '    ');
            log('filterOutput', '    if (activeSubprofile?.includedFields?.contextItems) {');
            log('filterOutput', '      // Filter items by ID matching');
            log('filterOutput', '      itemsToFilter = contextItems.filter(item => ');
            log('filterOutput', '        activeSubprofile.includedFields.contextItems.includes(item.id)');
            log('filterOutput', '      );');
            log('filterOutput', '    } else {');
            log('filterOutput', '      itemsToFilter = [];');
            log('filterOutput', '    }');
            log('filterOutput', '  }');
            log('filterOutput', '  ');
            log('filterOutput', '  return itemsToFilter;');
            log('filterOutput', '}');
            log('filterOutput', '');
            
            log('filterOutput', 'üîç Critical Points to Check:');
            log('filterOutput', '1. Do contextItem IDs match the format expected?');
            log('filterOutput', '2. Are the same IDs stored in subprofile.includedFields.contextItems?');
            log('filterOutput', '3. Does Array.includes() work with these ID formats?');
            log('filterOutput', '');
            
            log('filterOutput', 'üìä To manually test:');
            log('filterOutput', '1. Open extension popup');
            log('filterOutput', '2. Create a subprofile and select some items');
            log('filterOutput', '3. Watch console for these specific logs:');
            log('filterOutput', '   ‚Ä¢ "üîß Creating subprofile with data:"');
            log('filterOutput', '   ‚Ä¢ "üìä Selected contextItems:"');
            log('filterOutput', '   ‚Ä¢ "üîç Filtering for subprofile:"');
            log('filterOutput', '   ‚Ä¢ "‚úÖ Subprofile has contextItems field:"');
            log('filterOutput', '   ‚Ä¢ "üéØ Filtered items:"');
            
            setStepStatus(3, 'success');
            setStepStatus(4, 'active');
            document.getElementById('activeSubprofileTest').style.display = 'block';
            document.getElementById('createBtn').disabled = false;
            
            testActiveSubprofile();
        }

        function testActiveSubprofile() {
            const testDiv = document.getElementById('activeSubprofileTest');
            testDiv.innerHTML = `
                <p><strong>üéØ Active Subprofile Test</strong></p>
                <p>To test the active subprofile functionality:</p>
                <ol>
                    <li>Open the Data Gems extension popup</li>
                    <li>Create a subprofile if none exist</li>
                    <li>Select it from the dropdown</li>
                    <li>Check if only the selected items appear</li>
                </ol>
                <div class="debug-output" style="font-family: monospace; font-size: 12px;">
<strong>Expected Console Output:</strong>
üîÑ Switching to subprofile: [subprofile-id]
‚úÖ Active subprofile set to: [subprofile-id]
üîç Filtering for subprofile: [subprofile-id]
üìã Active subprofile data: {id: "...", includedFields: {contextItems: ["id1", "id2"]}}
üíæ Available contextItems: X items
üéØ contextItems IDs: ["id1", "id2", "id3", "id4"]
‚úÖ Subprofile has contextItems field: ["id1", "id2"]
üéØ Filtered items: 2

<strong style="color: #dc2626;">If you see this instead:</strong>
‚ùå Subprofile missing contextItems field or empty
üîç includedFields: {answers: [], contextItems: []}
üéØ Filtered items: 0

<strong style="color: #dc2626;">Then the issue is:</strong>
‚Ä¢ contextItems array is empty in the subprofile
‚Ä¢ Form data collection failed during subprofile creation
‚Ä¢ Checkbox values weren't processed correctly
                </div>
            `;
            setStepStatus(4, 'success');
            setStepStatus(5, 'active');
        }

        function createTestSubprofile() {
            setStepStatus(5, 'active');
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            log('createOutput', 'üß™ Test Subprofile Creation Process');
            log('createOutput', '');
            log('createOutput', 'üìã Manual Test Steps:');
            log('createOutput', '');
            log('createOutput', '1. Open Data Gems extension popup');
            log('createOutput', '2. Click the "+" button next to subprofile selector');
            log('createOutput', '3. Name the subprofile "TEST_PROFILE"');
            log('createOutput', '4. Select 2-3 contextItems (check the boxes)');
            log('createOutput', '5. Click "Create Subprofile"');
            log('createOutput', '6. Watch the console for creation logs');
            log('createOutput', '7. Switch to the new subprofile in dropdown');
            log('createOutput', '8. Verify only selected items appear');
            log('createOutput', '');
            
            log('createOutput', 'üîç Key Debug Points:');
            log('createOutput', '');
            log('createOutput', 'During Creation:');
            log('createOutput', '‚Ä¢ "üìä Selected contextItems:" should show array of IDs');
            log('createOutput', '‚Ä¢ "üíæ Final subprofile object:" should contain those IDs');
            log('createOutput', '');
            log('createOutput', 'During Filtering:');
            log('createOutput', '‚Ä¢ "üéØ contextItems IDs:" should show all available item IDs');
            log('createOutput', '‚Ä¢ "‚úÖ Subprofile has contextItems field:" should show selected IDs');
            log('createOutput', '‚Ä¢ "üéØ Filtered items:" should show count of matching items');
            log('createOutput', '');
            
            log('createOutput', 'üö® Common Issues:');
            log('createOutput', '‚Ä¢ IDs don\'t match (different format/generation)');
            log('createOutput', '‚Ä¢ Form data collection fails (checkbox names/values wrong)');
            log('createOutput', '‚Ä¢ Async timing issues (data not loaded when filtering)');
            log('createOutput', '‚Ä¢ Array includes fails (type mismatch)');
            
            setStepStatus(5, 'success');
            showTestResults();
        }

        function showTestResults() {
            document.getElementById('testResults').style.display = 'block';
            const summary = document.getElementById('resultsSummary');
            
            summary.innerHTML = `
                <div class="data-comparison">
                    <div class="data-column">
                        <h4>‚úÖ What Should Work</h4>
                        <ul>
                            <li>Items get unique IDs when created</li>
                            <li>Checkbox values capture item IDs</li>
                            <li>Subprofile stores ID arrays</li>
                            <li>Filtering matches by ID inclusion</li>
                        </ul>
                    </div>
                    <div class="data-column">
                        <h4>üîß Most Likely Issues</h4>
                        <ul>
                            <li>ID format inconsistency</li>
                            <li>Checkbox form processing</li>
                            <li>Async data loading timing</li>
                            <li>JavaScript array operations</li>
                        </ul>
                    </div>
                </div>
                
                <h3>üéØ Next Steps</h3>
                <ol>
                    <li><strong>Run the manual test above</strong> - Follow Step 5 instructions</li>
                    <li><strong>Check console logs</strong> - Look for the specific emoji-prefixed logs</li>
                    <li><strong>Compare IDs</strong> - Ensure item IDs match between creation and filtering</li>
                    <li><strong>Report findings</strong> - Share any mismatched IDs or error messages</li>
                </ol>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-top: 20px;">
                    <h4 style="color: #0369a1; margin-top: 0;">üí° The Implementation is Sound</h4>
                    <p>The tagging approach you described is already correctly implemented. If items aren't showing in subprofiles, it's likely a small bug in ID handling, not a fundamental design issue.</p>
                </div>
            `;
        }

        // Initialize the test
        console.log('üß™ Subprofile ID Matching Test loaded');
        console.log('üìã This test will help verify the Data Gems subprofile filtering system');
        console.log('üéØ Click "Load Data" to begin the test');
    </script>
</body>
</html>